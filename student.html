<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>GO GREEN â€“ Student</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<style>
body{font-family:Arial;background:#f4fff4;padding:20px}
h2{color:#2e7d32}
button{background:#2e7d32;color:#fff;border:none;padding:10px;margin:6px}
table{border-collapse:collapse;width:100%}
th,td{border:1px solid #ccc;padding:6px;text-align:center}
#scanner{display:none;margin-top:10px}
</style>
</head>

<body>

<script>
// ðŸ“± MOBILE ONLY ENFORCEMENT
if(!/Android|iPhone/i.test(navigator.userAgent)){
  alert("Attendance allowed only from mobile");
  location.href="index.html";
}
</script>

<h2>ðŸŒ± GO GREEN â€“ Student Dashboard</h2>

<button onclick="startQrScan()">ðŸ“· Scan QR & Mark Attendance</button>

<div id="scanner">
  <div id="qr-reader" style="width:280px"></div>
</div>

<hr>

<h3>My Attendance</h3>
<button onclick="viewAttendance()">View My Attendance</button>

<table id="attTable" style="display:none">
<thead>
<tr>
  <th>Date</th>
  <th>Role</th>
  <th>Status</th>
  <th>Time</th>
</tr>
</thead>
<tbody id="attBody"></tbody>
</table>

<!-- QR SCANNER LIBRARY -->
<script src="https://unpkg.com/html5-qrcode"></script>

<script>
const API="https://script.google.com/macros/s/AKfycbwV_SjR5wASHwKWjWd-fLlVFFWbc-pGAUUVXcYlEOUbH1JeUnwILr-nMhPvHWLoUW19BQ/exec";
const email = localStorage.getItem("email");
let qrScanner = null;

/* ---------------- API POST ---------------- */
function post(data){
  return fetch(API,{
    method:"POST",
    headers:{ "Content-Type":"text/plain;charset=utf-8" },
    body:JSON.stringify(data)
  }).then(r=>r.json());
}

/* ---------------- QR SCAN ---------------- */
function startQrScan(){
  document.getElementById("scanner").style.display="block";

  qrScanner = new Html5Qrcode("qr-reader");

  qrScanner.start(
    { facingMode: "environment" },
    { fps: 10, qrbox: 250 },
    qrText => {
      qrScanner.stop();
      document.getElementById("scanner").style.display="none";
      markAttendance(qrText);
    },
    err => {}
  );
}

/* ---------------- MARK ATTENDANCE ---------------- */
function markAttendance(sessionId){
  navigator.geolocation.getCurrentPosition(pos=>{
    post({
      action:"markStudentAttendance",
      email: email,
      sessionId: sessionId,
      latitude: pos.coords.latitude,
      longitude: pos.coords.longitude
    }).then(r=>{
      alert(r.message);
    });
  }, ()=>alert("GPS permission required"));
}

/* ---------------- VIEW ATTENDANCE ---------------- */
function viewAttendance(){
  post({ action:"getMyAttendance", email }).then(r=>{
    attBody.innerHTML="";
    r.data.forEach(x=>{
      attBody.innerHTML+=`
        <tr>
          <td>${new Date(x[0]).toLocaleDateString()}</td>
          <td>${x[2]}</td>
          <td>${x[6]}</td>
          <td>${new Date(x[8]).toLocaleTimeString()}</td>
        </tr>`;
    });
    attTable.style.display="table";
  });
}
</script>

</body>
</html>
