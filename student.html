<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>GO GREEN ‚Äì Student</title>
<meta name="viewport" content="width=device-width,initial-scale=1">

<style>
body{
  font-family:Arial;
  background:#f4fff4;
  padding:20px;
  user-select:none;
}
h2{color:#2e7d32}
button{
  background:#2e7d32;
  color:#fff;
  border:none;
  padding:10px;
  margin:6px;
}
table{border-collapse:collapse;width:100%}
th,td{border:1px solid #ccc;padding:6px;text-align:center}
#scanner,#faceCam{display:none;margin-top:12px}
</style>
</head>

<body>

<script>
/* MOBILE ONLY */
if(!/Android|iPhone/i.test(navigator.userAgent)){
  alert("Attendance allowed only from mobile");
  location.href="index.html";
}
</script>

<h2>üå± GO GREEN ‚Äì Student Dashboard</h2>

<button onclick="startQrScan()">üì∑ Scan QR & Mark Attendance</button>

<div id="scanner">
  <div id="qr-reader" style="width:300px"></div>
</div>

<div id="faceCam">
  <video id="video" autoplay playsinline width="260"></video><br>
  <button onclick="captureFace()">Capture Face & Submit</button>
</div>

<canvas id="canvas" width="260" height="200" style="display:none"></canvas>

<hr>

<h3>My Attendance</h3>
<button onclick="viewMyAttendance()">View My Attendance</button>

<table id="attTable" style="display:none">
<thead>
<tr>
<th>Date</th>
<th>Role</th>
<th>Status</th>
<th>Time</th>
</tr>
</thead>
<tbody id="attBody"></tbody>
</table>

<script src="https://unpkg.com/html5-qrcode"></script>

<script>
const API="https://script.google.com/macros/s/AKfycbwV_SjR5wASHwKWjWd-fLlVFFWbc-pGAUUVXcYlEOUbH1JeUnwILr-nMhPvHWLoUW19BQ/exec";
const email = localStorage.getItem("email");

let qrScanner=null;
let stream=null;
let sessionId="";
let subjectId="";
let signature="";

const video = document.getElementById("video");
const canvas = document.getElementById("canvas");

/* ---------- POST ---------- */
function post(data){
  return fetch(API,{
    method:"POST",
    headers:{"Content-Type":"text/plain;charset=utf-8"},
    body:JSON.stringify(data)
  }).then(r=>r.json());
}

/* ---------- QR SCAN ---------- */
function startQrScan(){
  document.getElementById("scanner").style.display="block";

  qrScanner = new Html5Qrcode("qr-reader");

  qrScanner.start(
    { facingMode:"environment" },
    { fps:10, qrbox:250 },
    text=>{
      const parts = text.split("|");
      sessionId = parts[0];
      signature = parts[1] || "";
      subjectId = parts[2] || "";

      qrScanner.stop();
      document.getElementById("scanner").style.display="none";
      openFaceCamera();
    }
  ).catch(()=>{
    alert("Camera permission error");
  });
}

/* ---------- FACE CAMERA ---------- */
function openFaceCamera(){
  document.getElementById("faceCam").style.display="block";
  alert("üî¥ Liveness Check: Blink & smile before capture");

  navigator.mediaDevices.getUserMedia({video:true})
    .then(s=>{
      stream=s;
      video.srcObject=s;
      video.play();
    })
    .catch(()=>{
      alert("Camera permission needed");
    });
}

/* ---------- CAPTURE ---------- */
function captureFace(){
  canvas.getContext("2d").drawImage(video,0,0,260,200);
  const faceImage = canvas.toDataURL("image/png");

  navigator.geolocation.getCurrentPosition(pos=>{
    post({
      action:"markStudentAttendance",
      email: email,
      sessionId: sessionId,
      subjectId: subjectId,
      signature: signature,
      deviceId: getDeviceId(),
      faceImage: faceImage,
      latitude: pos.coords.latitude,
      longitude: pos.coords.longitude
    })
    .then(r=>{
      alert(r.message);
      stopCam();
    })
    .catch(()=>{
      alert("Network error");
      stopCam();
    });

  },()=>{
    alert("GPS permission denied");
    stopCam();
  });
}

function stopCam(){
  if(stream) stream.getTracks().forEach(t=>t.stop());
  document.getElementById("faceCam").style.display="none";
}

/* ---------- VIEW ATTENDANCE ---------- */
function viewMyAttendance(){
  post({
    action:"getMyStudentAttendance",
    email: email
  })
  .then(r=>{
    if(!r.success || r.data.length===0){
      alert("No attendance found");
      return;
    }

    const body=document.getElementById("attBody");
    body.innerHTML="";

    r.data.forEach(x=>{
      body.innerHTML+=`
        <tr>
          <td>${new Date(x[0]).toLocaleDateString()}</td>
          <td>STUDENT</td>
          <td>${x[4]}</td>
          <td>${new Date(x[5]).toLocaleTimeString()}</td>
        </tr>`;
    });

    document.getElementById("attTable").style.display="table";
  })
  .catch(()=>alert("Network error"));
}

/* ---------- DEVICE ID ---------- */
function getDeviceId(){
  return btoa(
    navigator.userAgent +
    screen.width +
    screen.height +
    Intl.DateTimeFormat().resolvedOptions().timeZone
  );
}

/* ---------- SCREENSHOT DETECTOR ---------- */
document.addEventListener("visibilitychange",()=>{
  if(document.hidden){
    document.body.innerHTML="<h2>‚ö†Ô∏è Screenshot not allowed</h2>";
  }
});
</script>

</body>
</html>
