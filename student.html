<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>GO GREEN â€“ Student</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<style>
body{font-family:Arial;background:#f4fff4;padding:20px}
h2{color:#2e7d32}
button{background:#2e7d32;color:#fff;border:none;padding:10px;margin:6px}
video{border:1px solid #ccc}
table{border-collapse:collapse;width:100%}
th,td{border:1px solid #ccc;padding:6px}
</style>
</head>

<body>

<script>
// ðŸ“± MOBILE ONLY
if(!/Android|iPhone/i.test(navigator.userAgent)){
  alert("Attendance allowed only from mobile");
  location.href="index.html";
}
</script>

<h2>ðŸŒ± GO GREEN â€“ Student</h2>

<button onclick="startScan()">Scan QR & Mark Attendance</button>

<div id="cam" style="display:none">
  <video id="video" autoplay width="260"></video><br>
  <button onclick="capture()">Capture & Submit</button>
</div>

<canvas id="canvas" width="260" height="200" style="display:none"></canvas>

<hr>

<h3>My Attendance</h3>
<button onclick="viewAttendance()">View Attendance</button>

<table id="attTable" style="display:none">
<thead>
<tr><th>Date</th><th>Subject</th><th>Status</th><th>Time</th></tr>
</thead>
<tbody id="attBody"></tbody>
</table>

<script>
const API="https://script.google.com/macros/s/AKfycbwV_SjR5wASHwKWjWd-fLlVFFWbc-pGAUUVXcYlEOUbH1JeUnwILr-nMhPvHWLoUW19BQ/exec";
const email=localStorage.getItem("email");
let stream=null;
let sessionId="", subjectId="";

function post(d){
  return fetch(API,{
    method:"POST",
    headers:{"Content-Type":"text/plain;charset=utf-8"},
    body:JSON.stringify(d)
  }).then(r=>r.json());
}

function startScan(){
  sessionId=prompt("Paste Session ID from QR");
  subjectId=prompt("Enter Subject ID");
  if(!sessionId||!subjectId) return;

  cam.style.display="block";
  navigator.mediaDevices.getUserMedia({video:true})
    .then(s=>{stream=s;video.srcObject=s});
}

function capture(){
  canvas.getContext("2d").drawImage(video,0,0,260,200);

  navigator.geolocation.getCurrentPosition(pos=>{
    post({
      action:"markStudentAttendance",
      email,
      sessionId,
      subjectId,
      latitude:pos.coords.latitude,
      longitude:pos.coords.longitude
    }).then(r=>{
      alert(r.message);
      stopCam();
    });
  });
}

function stopCam(){
  if(stream) stream.getTracks().forEach(t=>t.stop());
  cam.style.display="none";
}

function viewAttendance(){
  post({action:"getMyAttendance",email}).then(r=>{
    attBody.innerHTML="";
    r.data.forEach(x=>{
      attBody.innerHTML+=`
      <tr>
        <td>${new Date(x[0]).toLocaleDateString()}</td>
        <td>${x[2]}</td>
        <td>${x[4]}</td>
        <td>${new Date(x[5]).toLocaleTimeString()}</td>
      </tr>`;
    });
    attTable.style.display="table";
  });
}
</script>

</body>
</html>
