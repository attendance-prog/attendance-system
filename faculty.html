<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>GO GREEN ‚Äì Faculty</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<style>
body{font-family:Arial;background:#f4fff4;padding:20px}
h2{color:#2e7d32}
button{background:#2e7d32;color:#fff;border:none;padding:8px;margin:4px;cursor:pointer}
button:disabled{background:#999}
video{border:1px solid #ccc}
</style>
</head>

<body>

<script>
if(localStorage.getItem("role")!=="faculty"){
  alert("Unauthorized");
  location.href="index.html";
}
</script>

<h2>üå± GO GREEN ‚Äì Faculty Dashboard</h2>
<button onclick="logout()">Logout</button>

<hr>

<h3>1Ô∏è‚É£ Mark My Attendance</h3>
<button onclick="startCamera()">Mark Attendance</button>
  <button onclick="viewMyAttendance()">View My Attendance</button>

<div id="cam" style="display:none;margin-top:10px">
  <video id="video" width="260" autoplay playsinline></video><br><br>
  <button onclick="captureAttendance()">Capture</button>
</div>

<canvas id="canvas" width="260" height="200" style="display:none"></canvas>
  <table id="attTable" style="display:none;margin-top:15px" border="1" cellpadding="6">
  <thead>
    <tr>
      <th>Date</th>
      <th>Status</th>
      <th>Time</th>
    </tr>
  </thead>
  <tbody id="attBody"></tbody>
</table>
<hr>

<h3>2Ô∏è‚É£ Generate QR (After Attendance)</h3>
<select id="subject">
  <option value="">Select Subject</option>
</select>
<button id="qrBtn" onclick="generateQR()" disabled>Generate QR</button>

<div id="qrBox"></div>

<script>
const API="https://script.google.com/macros/s/AKfycbwV_SjR5wASHwKWjWd-fLlVFFWbc-pGAUUVXcYlEOUbH1JeUnwILr-nMhPvHWLoUW19BQ/exec";
const email=localStorage.getItem("email");
let stream=null;

function logout(){localStorage.clear();location.href="index.html";}

function post(data){
  return fetch(API,{
    method:"POST",
    headers:{"Content-Type":"text/plain;charset=utf-8"},
    body:JSON.stringify(data)
  }).then(r=>r.json());
}

/* -------- ATTENDANCE -------- */
function startCamera(){
  document.getElementById("cam").style.display="block";

  navigator.mediaDevices.getUserMedia({ video:true })
    .then(s=>{
      stream=s;
      const v=document.getElementById("video");
      v.srcObject=s;
      v.play();               // üîë REQUIRED
    })
    .catch(()=>{
      alert("Camera permission denied");
    });
}


function captureAttendance(){
  const v=document.getElementById("video");
  const c=document.getElementById("canvas");

  if(!v.srcObject){
    alert("Camera not started");
    return;
  }

  c.getContext("2d").drawImage(v,0,0,260,200);

  navigator.geolocation.getCurrentPosition(pos=>{
    post({
      action:"markStaffAttendance",
      email: email,
      role: "FACULTY",
      latitude: pos.coords.latitude,
      longitude: pos.coords.longitude,
      room: "CLASSROOM"
    })
    .then(r=>{
      alert(r.success ? "‚úÖ Attendance marked" : "‚ùå "+r.message);
      if(r.success){
        qrBtn.disabled=false;
        loadSubjects();
      }
      stopCamera();
    })
    .catch(()=>{
      alert("Network error");
      stopCamera();
    });
  },()=>{
    alert("GPS permission denied");
  });
}

function stopCamera(){
  if(stream){
    stream.getTracks().forEach(t=>t.stop());
    stream=null;
  }
  document.getElementById("cam").style.display="none";
}


/* -------- QR -------- */
function loadSubjects(){
  post({action:"getSubjects"}).then(r=>{
    r.data.slice(1).forEach(s=>{
      subject.innerHTML+=`<option value="${s[0]}">${s[1]}</option>`;
    });
  });
}

function generateQR(){
  const sub=subject.value;
  if(!sub) return alert("Select subject");

  post({
    action:"createFacultySession",
    subjectId:sub,
    facultyEmail:email
  }).then(r=>{
    if(!r.success) return alert(r.message);

    qrBox.innerHTML=`
      <h4>QR valid for 5 minutes</h4>
      <img src="https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${r.sessionId}">
    `;
  });
}
  function viewMyAttendance(){
  post({
    action:"getMyAttendance",
    email: email
  }).then(r=>{
    if(!r.success || r.data.length===0){
      alert("No attendance found");
      return;
    }

    attBody.innerHTML="";
    r.data.forEach(x=>{
      attBody.innerHTML+=`
        <tr>
          <td>${new Date(x[0]).toLocaleDateString()}</td>
          <td>${x[6]}</td>
          <td>${new Date(x[8]).toLocaleTimeString()}</td>
        </tr>`;
    });

    attTable.style.display="table";
  })
  .catch(()=>alert("Network error"));
}

</script>

</body>
</html>
