<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>GO GREEN ‚Äì Faculty</title>
<meta name="viewport" content="width=device-width,initial-scale=1">

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://www.gstatic.com/charts/loader.js"></script>

<style>
body{
 font-family:Arial;
 padding:20px;
 background:linear-gradient(135deg,#e8f5e9,#c8e6c9);
}
h2{color:#2e7d32}
button{background:#2e7d32;color:#fff;border:none;padding:8px;margin:4px}
#welcomeBar{
 background:#1b5e20;
 color:white;
 padding:12px;
 border-radius:8px;
 margin-bottom:15px;
}
#toast{
 position:fixed;
 bottom:20px;
 right:20px;
 background:#1b5e20;
 color:white;
 padding:10px 16px;
 border-radius:6px;
 display:none;
}
table{border-collapse:collapse}
td,th{padding:6px}
</style>
</head>

<body>

<script>
if(localStorage.getItem("role")!=="faculty"){
 alert("Unauthorized");
 location.href="index.html";
}
</script>

<div id="welcomeBar"></div>

<h2>üå± GO GREEN ‚Äì Faculty Dashboard</h2>
<button onclick="logout()">Logout</button>

<hr>

<h3>Mark My Attendance</h3>
<button onclick="startCamera()">Mark Attendance</button>
<button onclick="viewMyAttendance()">View My Attendance</button>

<div id="cam" style="display:none">
<video id="video" width="260" autoplay playsinline></video><br>
<button onclick="captureAttendance()">Capture</button>
</div>

<canvas id="canvas" width="260" height="200" style="display:none"></canvas>

<table id="attTable" style="display:none" border="1">
<thead>
<tr><th>Date</th><th>Status</th><th>Time</th></tr>
</thead>
<tbody id="attBody"></tbody>
</table>

<hr>

<h3>Generate QR Session</h3>

<select id="subject"></select><br>
<input id="topic" placeholder="Topic"><br>
<input id="notes" placeholder="Notes link"><br>

<button id="qrBtn" onclick="generateQR()" disabled>Generate QR</button>

<div id="qrBox"></div>
<div id="qrTimer"></div>

<hr>

<h3>üìä My Attendance Trend</h3>
<canvas id="attChart"></canvas>

<hr>

<h3>üìä My Attendance Analytics</h3>
Attendance %: <b id="myPct">--</b>
<div id="myChart" style="height:300px"></div>

<hr>

<h3>üìÖ My Timetable</h3>
<table id="myTT" border="1">
<thead>
<tr>
<th>Day</th>
<th>09:00‚Äì09:50</th>
<th>09:50‚Äì10:40</th>
<th>10:40‚Äì11:30</th>
<th>11:35‚Äì12:25</th>
<th>13:15‚Äì14:05</th>
<th>14:10‚Äì15:00</th>
<th>15:00‚Äì15:50</th>
<th>15:50‚Äì16:40</th>
</tr>
</thead>
<tbody></tbody>
</table>

<div id="toast"></div>

<script>
const API="https://script.google.com/macros/s/AKfycbwV_SjR5wASHwKWjWd-fLlVFFWbc-pGAUUVXcYlEOUbH1JeUnwILr-nMhPvHWLoUW19BQ/exec"; // ‚Üê keep your deployed URL

const email=localStorage.getItem("email");
const name=localStorage.getItem("name") || email.split("@")[0];

const subjectSel=document.getElementById("subject");
const qrBtn=document.getElementById("qrBtn");
const qrBox=document.getElementById("qrBox");
const qrTimerEl=document.getElementById("qrTimer");
const toastBox=document.getElementById("toast");

let stream=null;
let qrCountdown=null;

/* ========= UTIL ========= */

function post(d){
 return fetch(API,{
  method:"POST",
  headers:{"Content-Type":"text/plain"},
  body:JSON.stringify(d)
 }).then(r=>r.json());
}

function toast(m){
 toastBox.innerText=m;
 toastBox.style.display="block";
 setTimeout(()=>toastBox.style.display="none",2500);
}

function logout(){
 localStorage.clear();
 location.href="index.html";
}

/* ========= GREETING ========= */

const hr=new Date().getHours();
const g=hr<12?"Good Morning":hr<18?"Good Afternoon":"Good Evening";
document.getElementById("welcomeBar").innerHTML =
 `${g}, ${name} üëã | Faculty Portal`;

/* ========= CAMERA ========= */

function startCamera(){
 document.getElementById("cam").style.display="block";
 navigator.mediaDevices.getUserMedia({video:true})
 .then(s=>{
   stream=s;
   document.getElementById("video").srcObject=s;
 })
 .catch(()=>toast("Camera permission denied"));
}

function captureAttendance(){
 navigator.geolocation.getCurrentPosition(pos=>{
   post({
     action:"markStaffAttendance",
     email,
     role:"FACULTY",
     latitude:pos.coords.latitude,
     longitude:pos.coords.longitude,
     room:"CLASSROOM"
   }).then(r=>{
     toast(r.message);
     if(r.success){
       qrBtn.disabled=false;
       loadSubjects();
       loadMyAnalytics();
     }
     stopCamera();
   });
 });
}

function stopCamera(){
 if(stream) stream.getTracks().forEach(t=>t.stop());
 document.getElementById("cam").style.display="none";
}

/* ========= ATTENDANCE VIEW ========= */

function viewMyAttendance(){
 post({action:"getMyAttendance",email})
 .then(r=>{
   const body=document.getElementById("attBody");
   body.innerHTML="";
   r.data.forEach(x=>{
     body.innerHTML+=`
     <tr>
       <td>${new Date(x[0]).toLocaleDateString()}</td>
       <td>${x[6]}</td>
       <td>${new Date(x[8]).toLocaleTimeString()}</td>
     </tr>`;
   });
   document.getElementById("attTable").style.display="table";
   drawChart(r.data);
 });
}

/* ========= TREND CHART ========= */

function drawChart(rows){
 new Chart(document.getElementById("attChart"),{
   type:"line",
   data:{
     labels:rows.map(r=>new Date(r[0]).toLocaleDateString()),
     datasets:[{
       label:"Present",
       data:rows.map(r=>r[6]==="PRESENT"?1:0)
     }]
   }
 });
}

/* ========= SUBJECTS (OWN ONLY) ========= */

function loadSubjects(){
 post({
   action:"getFacultySubjects",
   email:email
 }).then(r=>{
   subjectSel.innerHTML="";
   r.data.forEach(s=>{
     subjectSel.innerHTML+=
       `<option value="${s[0]}">${s[1]}</option>`;
   });
 });
}
function isWithinSlot(){

 const now = new Date();
 const time = now.getHours() + now.getMinutes()/60;

 /* YOUR SLOT TABLE */
 const slots = [
  [9.00,9.50],
  [9.50,10.40],
  [10.40,11.30],
  [11.35,12.25],
  [13.15,14.05],
  [14.10,15.00],
  [15.00,15.50],
  [15.50,16.40]
 ];

 return slots.some(s => time >= s[0] && time <= s[1]);
}

/* ========= QR ========= */

function generateQR(){

 if(!subjectSel.value){
   toast("Select subject first");
   return;
 }

 /* FRONT SLOT CHECK */
 if(!isWithinSlot()){
   alert("‚ùå QR can be generated only during your lecture time slot");
   return;
 }

 navigator.geolocation.getCurrentPosition(pos=>{

   post({
     action:"createFacultySession",
     subjectId:subjectSel.value,
     facultyEmail:email,
     latitude:pos.coords.latitude,
     longitude:pos.coords.longitude,
     topic:document.getElementById("topic").value,
     notesLink:document.getElementById("notes").value
   })
   .then(r=>{

     if(!r.success){
       alert("‚ùå " + r.message);
       return;
     }

     qrBox.innerHTML =
       `<img src="https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${r.sessionId}">`;

     startQrTimer(300);

   });

 });

}

/* ========= QR TIMER ========= */

function startQrTimer(sec){
 clearInterval(qrCountdown);
 qrCountdown=setInterval(()=>{
   sec--;
   qrTimerEl.innerText="QR expires in "+sec+" sec";
   if(sec<=0){
     clearInterval(qrCountdown);
     qrTimerEl.innerText="QR expired";
     qrBox.innerHTML="";
   }
 },1000);
}

/* ========= OWN ANALYTICS ========= */

google.charts.load('current',{packages:['corechart']});
google.charts.setOnLoadCallback(loadMyAnalytics);

function loadMyAnalytics(){
 post({action:"getMyAttendanceAnalytics",email})
 .then(r=>{
   if(!r.success) return;

   document.getElementById("myPct").innerText=r.percent+"%";

   const data=google.visualization.arrayToDataTable([
     ["Status","Count"],
     ["Present",r.present],
     ["Late",r.late],
     ["Absent",r.absent]
   ]);

   new google.visualization.PieChart(
     document.getElementById("myChart")
   ).draw(data);
 });
}

/* ========= OWN TIMETABLE ========= */

function loadMyTimetable(){

post({
  action:"getFacultyOwnTimetable",
  email: email
})
 .then(r=>{

   const slots=[9,9.5,10.4,11.35,13.15,14.1,15,15.5];
   const days=["Monday","Tuesday","Wednesday","Thursday","Friday"];

   const body=document.querySelector("#myTT tbody");
   body.innerHTML="";

   days.forEach(d=>{
     let row=`<tr><td>${d}</td>`;

     slots.forEach(s=>{
       const lec=r.data.find(x =>
         x.day===d && Number(x.start)==Number(s)
       );
       row += lec
        ? `<td>${lec.subject}<br>Room ${lec.room}</td>`
        : `<td></td>`;
     });

     row+="</tr>";
     body.innerHTML+=row;
   });

 });
}

/* ========= INIT ========= */

loadSubjects();
loadMyAnalytics();
loadMyTimetable();
 function controlQrButtonByTime(){

 if(isWithinSlot()){
   qrBtn.disabled = false;
 } else {
   qrBtn.disabled = true;
 }

}

setInterval(controlQrButtonByTime, 60000);
controlQrButtonByTime();


</script>

</body>
</html>
