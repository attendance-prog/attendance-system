<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>GO GREEN â€“ HOD Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
body{font-family:Arial;background:#f4fff4;padding:20px}
h2{color:#2e7d32}
button{background:#2e7d32;color:#fff;border:none;padding:8px;margin:4px;cursor:pointer}
input,select{padding:6px;margin:4px}
table{border-collapse:collapse;width:100%}
th,td{border:1px solid #ccc;padding:6px}
</style>
</head>

<body>

<script>
(() => {
  if(localStorage.getItem("role")!=="hod"){
    alert("Unauthorized");
    location.href="index.html";
  }
})();
</script>

<h2>ðŸŒ± GO GREEN â€“ HOD Dashboard</h2>
<button onclick="logout()">Logout</button>

<!-- MARK ATTENDANCE -->
<h3>My Attendance</h3>
<button onclick="startCamera()">Mark My Attendance</button>
<button onclick="viewMyAttendance()">View My Attendance</button>

<div id="cam" style="display:none">
  <video id="video" autoplay width="260"></video><br>
  <button onclick="capture()">Capture</button>
</div>
<canvas id="canvas" width="260" height="200" style="display:none"></canvas>

<table id="attTable" style="display:none">
<thead><tr><th>Date</th><th>Status</th><th>Time</th></tr></thead>
<tbody id="attBody"></tbody>
</table>

<!-- SUBJECT -->
<h3>Add Subject</h3>
<input id="sid" placeholder="Subject ID">
<input id="sname" placeholder="Subject Name">
<input id="sem" placeholder="Semester">
<button onclick="addSubject()">Add</button>

<!-- TIMETABLE -->
<h3>Add Timetable</h3>
<select id="day">
<option>Monday</option><option>Tuesday</option><option>Wednesday</option>
<option>Thursday</option><option>Friday</option>
</select>
<input id="tsub" placeholder="Subject ID">
<input id="start" placeholder="Start (HH.MM)">
<input id="end" placeholder="End (HH.MM)">
<input id="room" placeholder="Room">
<button onclick="addTimetable()">Add</button>

<!-- GPS -->
<h3>Add GPS Location</h3>
<input id="groom" placeholder="Room">
<input id="lat" placeholder="Latitude">
<input id="lng" placeholder="Longitude">
<input id="rad" placeholder="Radius (m)">
<button onclick="addLocation()">Add</button>

<script>
const API="https://script.google.com/macros/s/AKfycbwV_SjR5wASHwKWjWd-fLlVFFWbc-pGAUUVXcYlEOUbH1JeUnwILr-nMhPvHWLoUW19BQ/exec";
const email=localStorage.getItem("email");
let stream=null;

function logout(){localStorage.clear();location.href="index.html"}

function post(d){return fetch(API,{method:"POST",body:JSON.stringify(d)}).then(r=>r.json())}

function startCamera(){
  cam.style.display="block";
  navigator.mediaDevices.getUserMedia({video:true}).then(s=>{
    stream=s;video.srcObject=s;
  });
}

function capture(){
  canvas.getContext("2d").drawImage(video,0,0,260,200);
  navigator.geolocation.getCurrentPosition(pos=>{
    post({
      action:"markHodAttendance",
      email,
      latitude:pos.coords.latitude,
      longitude:pos.coords.longitude
    }).then(r=>{
      alert(r.message);
      stream.getTracks().forEach(t=>t.stop());
      cam.style.display="none";
    });
  });
}

function viewMyAttendance(){
  post({action:"getMyAttendance",email}).then(r=>{
    attBody.innerHTML="";
    r.data.forEach(x=>{
      attBody.innerHTML+=`
      <tr><td>${new Date(x[0]).toLocaleDateString()}</td>
      <td>${x[6]}</td>
      <td>${new Date(x[8]).toLocaleTimeString()}</td></tr>`;
    });
    attTable.style.display="table";
  });
}

function addSubject(){
  post({action:"addSubject",subjectId:sid.value,subjectName:sname.value,department:"HOD",semester:sem.value})
  .then(()=>alert("Subject Added"));
}

function addTimetable(){
  post({action:"addTimetable",day:day.value,subjectId:tsub.value,start:start.value,end:end.value,room})
  .then(()=>alert("Timetable Added"));
}

function addLocation(){
  post({action:"addLocation",room:groom.value,lat, lng, radius:rad.value})
  .then(()=>alert("Location Added"));
}
</script>
</body>
</html>
