<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>GO GREEN â€“ Admin Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="stylesheet"
 href="https://unpkg.com/leaflet/dist/leaflet.css"/>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<style>
body{
  font-family:Arial;
  padding:20px;
  background:linear-gradient(135deg,#e8f5e9,#c8e6c9);
}

h2{color:#2e7d32}
section{margin-bottom:30px}
input,select,button{padding:8px;margin:4px}
button{background:#2e7d32;color:#fff;border:none;cursor:pointer}

table{border-collapse:collapse;width:100%}
th,td{border:1px solid #ccc;padding:6px}

#welcomeBar{
  background:#1b5e20;
  color:white;
  padding:12px;
  border-radius:8px;
  margin-bottom:15px;
}

/* toast */
#toast{
 position:fixed;
 bottom:20px;
 right:20px;
 background:#1b5e20;
 color:#fff;
 padding:10px 16px;
 border-radius:6px;
 display:none;
}
</style>
</head>

<body>

<div id="welcomeBar"></div>

<h2>ğŸŒ± GO GREEN â€“ Admin Dashboard</h2>
<button onclick="logout()">Logout</button>

<!-- ================= ANALYTICS ================= -->
<section>
<h3>ğŸ“Š Attendance Analytics</h3>
<canvas id="subjectChart"></canvas>
</section>

<!-- ================= MAP ================= -->
<section>
<h3>ğŸ—º Attendance GPS Map</h3>
<div id="map" style="height:350px"></div>
</section>

<!-- ================= ROLE CONTROL ================= -->
<section>
<h3>ğŸ‘‘ Role Control Panel</h3>
<input id="roleEmail" placeholder="User Email">
<select id="roleSel">
<option>student</option>
<option>faculty</option>
<option>hod</option>
<option>admin</option>
<option>coordinator</option>
</select>
<button onclick="updateRole()">Update Role</button>
</section>

<!-- ================= EXPORT ================= -->
<section>
<h3>ğŸ“ Export</h3>
<button onclick="exportCSV()">Export Student Attendance CSV</button>
</section>

<!-- ================= RISK ================= -->
<section>
<h3>âš  Risk Students (&lt;75%)</h3>
<button onclick="loadRisk()">Check Risk List</button>
<ul id="riskList"></ul>
</section>

<div id="toast"></div>

<script>
const API="https://script.google.com/macros/s/AKfycbwV_SjR5wASHwKWjWd-fLlVFFWbc-pGAUUVXcYlEOUbH1JeUnwILr-nMhPvHWLoUW19BQ/exec";
const email=localStorage.getItem("email");

/* ========= UTIL ========= */
function post(data){
 return fetch(API,{
  method:"POST",
  headers:{"Content-Type":"text/plain"},
  body:JSON.stringify(data)
 }).then(r=>r.json());
}

function toast(msg){
 const t=document.getElementById("toast");
 t.innerText=msg;
 t.style.display="block";
 setTimeout(()=>t.style.display="none",3000);
}

function logout(){
 localStorage.clear();
 location.href="index.html";
}

/* ========= GREETING ========= */
const name = localStorage.getItem("name") || email.split("@")[0];
const role = localStorage.getItem("role");
const hr = new Date().getHours();
const greet = hr<12?"Good Morning":hr<18?"Good Afternoon":"Good Evening";

welcomeBar.innerHTML =
 `${greet}, ${name} ğŸ‘‹ | Role: ${role.toUpperCase()}`;

/* ========= ANALYTICS CHART ========= */
function loadAnalytics(){
 post({action:"getAnalytics"}).then(r=>{
   const labels=Object.keys(r.subject);
   const values=Object.values(r.subject);

   new Chart(subjectChart,{
     type:"bar",
     data:{
       labels,
       datasets:[{
         label:"Attendance Count",
         data:values
       }]
     }
   });
 });
}
loadAnalytics();

/* ========= MAP ========= */
function loadMap(){
 const map=L.map("map").setView([28.47,77.48],16);

 L.tileLayer(
  "https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png"
 ).addTo(map);

 post({action:"getGpsPoints"}).then(r=>{
   r.points.forEach(p=>{
     L.marker([p.lat,p.lng])
      .addTo(map)
      .bindPopup(p.email);
   });
 });
}
loadMap();

/* ========= ROLE UPDATE ========= */
function updateRole(){
 post({
  action:"adminUpdateRole",
  email:roleEmail.value,
  role:roleSel.value
 }).then(()=>toast("Role updated"));
}

/* ========= EXPORT CSV ========= */
function exportCSV(){
 post({action:"getStudents"}).then(r=>{
   let csv="Roll,Email\n";
   r.data.forEach(x=>{
     csv+=x.join(",")+"\n";
   });

   const blob=new Blob([csv]);
   const a=document.createElement("a");
   a.href=URL.createObjectURL(blob);
   a.download="students.csv";
   a.click();
 });
}

/* ========= RISK LIST ========= */
function loadRisk(){
 post({action:"getStudents"}).then(r=>{
   riskList.innerHTML="";
   r.data.forEach(st=>{
     post({
       action:"getStudentPercent",
       email:st[1]
     }).then(p=>{
       if(p.percent<75){
         riskList.innerHTML+=
           `<li>${st[1]} â€” ${p.percent}%</li>`;
       }
     });
   });
 });
}
</script>

</body>
</html>
