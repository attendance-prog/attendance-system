<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>GO GREEN ‚Äì Admin Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Charts + Map -->
<script src="https://www.gstatic.com/charts/loader.js"></script>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<style>
body{
  font-family:Arial;
  padding:20px;
  background:linear-gradient(135deg,#e8f5e9,#c8e6c9);
}
h2{color:#2e7d32}
section{margin-bottom:30px}
button{
  background:#2e7d32;
  color:#fff;
  border:none;
  padding:8px;
  margin:4px;
  cursor:pointer;
}
input,select{padding:8px;margin:4px}
table{border-collapse:collapse;width:100%}
th,td{border:1px solid #ccc;padding:6px}
#welcomeBar{
  background:#ffffffaa;
  padding:10px;
  border-radius:8px;
  margin-bottom:15px;
}
#map{height:320px;border-radius:10px}
</style>
</head>

<body>

<!-- LOGIN GUARD -->
<script>
if(localStorage.getItem("role")!=="admin"){
  alert("Unauthorized");
  location.href="index.html";
}
</script>

<h2>üå± GO GREEN ‚Äì Admin Dashboard</h2>
<div id="welcomeBar"></div>
<button onclick="logout()">Logout</button>

<!-- ================= MY ATTENDANCE ================= -->
<section>
<h3>My Attendance</h3>

<button onclick="markMyAttendance()">Mark My Attendance</button>
<button onclick="viewMyAttendance()">View My Attendance</button>

<div id="cameraSection" style="display:none">
  <video id="video" width="260" autoplay></video><br>
  <button onclick="captureAndMark()">Capture</button>
</div>

<canvas id="canvas" width="260" height="200" style="display:none"></canvas>

<table id="myAttendanceSection" style="display:none">
<thead>
<tr><th>Date</th><th>Status</th><th>Time</th></tr>
</thead>
<tbody id="myAttendanceBody"></tbody>
</table>
</section>

<!-- ================= ANALYTICS ================= -->
<section>
<h3>üìä Attendance Analytics</h3>
<div id="chartDiv" style="height:300px"></div>
</section>

<!-- ================= GPS MAP ================= -->
<section>
<h3>üó∫ Attendance GPS Map</h3>
<div id="map"></div>
</section>

<!-- ================= ROLE CONTROL ================= -->
<section>
<h3>üëë Role Control Panel</h3>
<input id="userEmail" placeholder="User Email">
<select id="activeSel">
<option value="true">Active</option>
<option value="false">Inactive</option>
</select>
<button onclick="setActive()">Update Status</button>
</section>

<!-- ================= EXPORT ================= -->
<section>
<h3>üìÅ Export</h3>
<button onclick="exportCSV()">Export Student Attendance CSV</button>
</section>

<!-- ================= ADD SUBJECT ================= -->
<section>
<h3>Add Subject</h3>
<input id="sid" placeholder="Subject ID">
<input id="sname" placeholder="Subject Name">
<input id="dept" placeholder="Department">
<input id="sem" placeholder="Semester">
<button onclick="addSubject()">Add</button>
</section>

<!-- ================= ADD LOCATION ================= -->
<section>
<h3>Add Location</h3>
<input id="room" placeholder="Room">
<input id="lat" placeholder="Latitude">
<input id="lng" placeholder="Longitude">
<input id="rad" placeholder="Radius">
<button onclick="addLocation()">Add</button>
</section>

<!-- ================= FACULTY ================= -->
<section>
<h3>Faculty Panel</h3>
<table>
<thead><tr><th>Name</th><th>Email</th><th>Status</th></tr></thead>
<tbody id="facultyBody"></tbody>
</table>
</section>

<!-- ================= STUDENTS ================= -->
<section>
<h3>Student Panel</h3>
<table>
<thead><tr><th>Roll</th><th>Name</th><th>Email</th></tr></thead>
<tbody id="studentBody"></tbody>
</table>
</section>

<script>
const API_URL="https://script.google.com/macros/s/AKfycbwV_SjR5wASHwKWjWd-fLlVFFWbc-pGAUUVXcYlEOUbH1JeUnwILr-nMhPvHWLoUW19BQ/exec";
const email=localStorage.getItem("email");

function post(d){
 return fetch(API_URL,{
  method:"POST",
  headers:{"Content-Type":"text/plain;charset=utf-8"},
  body:JSON.stringify(d)
 }).then(r=>r.json());
}

function logout(){
 localStorage.clear();
 location.href="index.html";
}

/* ===== GREETING ===== */
const name=localStorage.getItem("name")||"Admin";
const hr=new Date().getHours();
const greet=hr<12?"Good Morning":hr<18?"Good Afternoon":"Good Evening";
welcomeBar.innerHTML=`${greet}, ${name} üëã`;

/* ===== CAMERA ATTENDANCE ===== */
let stream=null;

function markMyAttendance(){
 cameraSection.style.display="block";
 navigator.mediaDevices.getUserMedia({video:true}).then(s=>{
  stream=s; video.srcObject=s;
 });
}

function captureAndMark(){
 canvas.getContext("2d").drawImage(video,0,0,260,200);
 navigator.geolocation.getCurrentPosition(pos=>{
  post({
   action:"markStaffAttendance",
   email,
   role:"ADMIN",
   latitude:pos.coords.latitude,
   longitude:pos.coords.longitude
  }).then(()=>alert("Attendance marked"));
  stopCam();
 });
}

function stopCam(){
 if(stream) stream.getTracks().forEach(t=>t.stop());
 cameraSection.style.display="none";
}

function viewMyAttendance(){
 post({action:"getMyAttendance",email})
 .then(r=>{
  myAttendanceBody.innerHTML="";
  r.data.forEach(x=>{
   myAttendanceBody.innerHTML+=`
   <tr>
    <td>${new Date(x[0]).toLocaleDateString()}</td>
    <td>${x[6]}</td>
    <td>${new Date(x[8]).toLocaleTimeString()}</td>
   </tr>`;
  });
  myAttendanceSection.style.display="table";
 });
}

/* ===== ANALYTICS CHART ===== */
google.charts.load('current',{packages:['corechart']});
google.charts.setOnLoadCallback(loadChart);

function loadChart(){
 post({action:"getAnalytics"}).then(r=>{
  const data=google.visualization.arrayToDataTable([
   ["Type","Count"],
   ["Present",r.present],
   ["Total",r.total]
  ]);
  new google.visualization.PieChart(chartDiv)
    .draw(data,{title:"Overall Attendance"});
 });
}

/* ===== MAP ===== */
const map=L.map('map').setView([28.47,77.48],10);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

post({action:"getGpsPoints"}).then(r=>{
 r.data.forEach(p=>{
  if(p.lat) L.marker([p.lat,p.lng]).addTo(map);
 });
});

/* ===== ROLE ACTIVE ===== */
function setActive(){
 post({
  action:"setUserActive",
  email:userEmail.value,
  active:activeSel.value==="true"
 }).then(()=>alert("Updated"));
}

/* ===== SUBJECT + LOCATION ===== */
function addSubject(){
 post({
  action:"addSubject",
  subjectId:sid.value,
  subjectName:sname.value,
  department:dept.value,
  semester:sem.value
 }).then(()=>alert("Subject added"));
}

function addLocation(){
 post({
  action:"addLocation",
  room:room.value,
  lat:lat.value,
  lng:lng.value,
  radius:rad.value
 }).then(()=>alert("Location added"));
}

/* ===== FACULTY + STUDENTS ===== */
post({action:"getFaculty"}).then(r=>{
 r.data.forEach(x=>{
  facultyBody.innerHTML+=`<tr>
  <td>${x[2]}</td><td>${x[1]}</td><td>${x[3]}</td></tr>`;
 });
});

post({action:"getStudents"}).then(r=>{
 r.data.forEach(x=>{
  studentBody.innerHTML+=`<tr>
  <td>${x[0]}</td><td>${x[1]}</td><td>${x[2]}</td></tr>`;
 });
});

/* ===== EXPORT ===== */
function exportCSV(){
 window.open(API_URL+"?export=students");
}
</script>

</body>
</html>
