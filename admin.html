<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>GO GREEN â€“ Admin Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
  body{
  font-family:Arial;
  padding:20px;
  background:
    linear-gradient(135deg,#e8f5e9,#c8e6c9);
}
  h2 { color:#2e7d32; }
  section { margin-bottom: 30px; }
  input, button { padding:8px; margin:4px; }
  button { background:#2e7d32; color:#fff; border:none; cursor:pointer; }
  table { border-collapse: collapse; width: 100%; }
  th, td { border:1px solid #ccc; padding:6px; text-align:left; }
<h3 id="welcomeBar"></h3>
</style>
</head>

<body>

<!-- ðŸ”’ LOGIN GUARD -->
<script>
(function () {
  const email = localStorage.getItem("email");
  const role  = localStorage.getItem("role");
  if (!email || role !== "admin") {
    alert("Unauthorized access. Please login.");
    window.location.href = "index.html";
  }
})();
</script>

<h2>ðŸŒ± GO GREEN â€“ Admin Dashboard</h2>
<button onclick="logout()">Logout</button>

<!-- ================= ATTENDANCE ================= -->
<section>
  <h3>My Attendance</h3>
  <button onclick="markMyAttendance()">Mark My Attendance</button>
  <button onclick="viewMyAttendance()">View My Attendance</button>

  <!-- Camera -->
  <div id="cameraSection" style="display:none; margin-top:15px;">
    <video id="video" width="260" autoplay></video><br><br>
    <button onclick="captureAndMark()">Capture Attendance</button>
  </div>

  <canvas id="canvas" width="260" height="200" style="display:none;"></canvas>

  <!-- Attendance Table -->
  <div id="myAttendanceSection" style="display:none; margin-top:20px;">
    <table>
      <thead>
        <tr>
          <th>Date</th>
          <th>Status</th>
          <th>Time</th>
        </tr>
      </thead>
      <tbody id="myAttendanceBody"></tbody>
    </table>
  </div>
</section>

<!-- ================= FACULTY PANEL ================= -->
<section>
  <h3>Faculty Panel (View Only)</h3>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Email</th>
        <th>Status</th>
      </tr>
    </thead>
    <tbody id="facultyBody"></tbody>
  </table>
</section>

<!-- ================= STUDENT PANEL ================= -->
<section>
  <h3>Student Panel (View Only)</h3>
  <table>
    <thead>
      <tr>
        <th>Roll No</th>
        <th>Name</th>
        <th>Email</th>
      </tr>
    </thead>
    <tbody id="studentBody"></tbody>
  </table>
</section>

<!-- ================= LOCATION ================= -->
<section>
  <h3>Add Location</h3>
  <input id="room" placeholder="Room No">
  <input id="lat" placeholder="Latitude">
  <input id="lng" placeholder="Longitude">
  <input id="rad" placeholder="Radius">
  <button onclick="addLocation()">Add</button>
</section>

<!-- ================= SUBJECT ================= -->
<section>
  <h3>Add Subject</h3>
  <input id="sid" placeholder="Subject ID">
  <input id="sname" placeholder="Subject Name">
  <input id="dept" placeholder="Department">
  <input id="sem" placeholder="Semester">
  <button onclick="addSubject()">Add</button>
</section>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbwV_SjR5wASHwKWjWd-fLlVFFWbc-pGAUUVXcYlEOUbH1JeUnwILr-nMhPvHWLoUW19BQ/exec";
const email = localStorage.getItem("email");

/* -------- LOGOUT -------- */
function logout() {
  localStorage.clear();
  location.href = "index.html";
}

/* -------- CAMERA ATTENDANCE -------- */
let stream = null;

function markMyAttendance() {
  document.getElementById("cameraSection").style.display = "block";
  navigator.mediaDevices.getUserMedia({ video:true })
    .then(s => {
      stream = s;
      video.srcObject = s;
    })
    .catch(() => alert("Camera permission denied"));
}

function captureAndMark() {
  const ctx = canvas.getContext("2d");
  ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

  navigator.geolocation.getCurrentPosition(pos => {
    fetch(API_URL, {
      method:"POST",
      body:JSON.stringify({
        action:"markStaffAttendance",
        email: email,
        role:"ADMIN",
        latitude: pos.coords.latitude,
        longitude: pos.coords.longitude
      })
    })
    .then(r=>r.json())
    .then(() => {
      alert("âœ… Attendance marked successfully");
      stopCamera();
    });
  });
}

function stopCamera() {
  if (stream) stream.getTracks().forEach(t=>t.stop());
  stream = null;
  cameraSection.style.display="none";
}

/* -------- VIEW MY ATTENDANCE -------- */
function viewMyAttendance() {
  fetch(API_URL,{
    method:"POST",
    body:JSON.stringify({ action:"getMyAttendance", email })
  })
  .then(r=>r.json())
  .then(res=>{
    myAttendanceBody.innerHTML="";
    res.data.forEach(r=>{
      myAttendanceBody.innerHTML += `
        <tr>
          <td>${new Date(r[0]).toLocaleDateString()}</td>
          <td>${r[6]}</td>
          <td>${new Date(r[8]).toLocaleTimeString()}</td>
        </tr>`;
    });
    myAttendanceSection.style.display="block";
  });
}

/* -------- FACULTY -------- */
function loadFaculty() {
  fetch(API_URL,{
    method:"POST",
    body:JSON.stringify({ action:"getFaculty" })
  })
  .then(r=>r.json())
  .then(res=>{
    facultyBody.innerHTML="";
    res.data.forEach(r=>{
      facultyBody.innerHTML += `
        <tr>
          <td>${r[2]}</td>
          <td>${r[1]}</td>
          <td>${r[3]}</td>
        </tr>`;
    });
  });
}

/* -------- STUDENTS -------- */
function loadStudents() {
  fetch(API_URL,{
    method:"POST",
    body:JSON.stringify({ action:"getStudents" })
  })
  .then(r=>r.json())
  .then(res=>{
    studentBody.innerHTML="";
    res.data.forEach(r=>{
      studentBody.innerHTML += `
        <tr>
          <td>${r[0]}</td>
          <td>${r[1]}</td>
          <td>${r[2]}</td>
        </tr>`;
    });
  });
}

/* Load panels on page load */
loadFaculty();
loadStudents();
  const name = localStorage.getItem("name") || "User";
const role = localStorage.getItem("role") || "";

const hr = new Date().getHours();
let greet = hr<12?"Good Morning":
            hr<18?"Good Afternoon":"Good Evening";

document.getElementById("welcomeBar").innerHTML =
  `${greet}, ${name} ðŸ‘‹ <br><small>Role: ${role.toUpperCase()}</small>`;

</script>

</body>
</html>
