<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>GO GREEN â€“ Admin Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
  body { font-family: Arial; background:#f4fff4; padding:20px; }
  h2 { color:#2e7d32; }
  section { margin-bottom: 20px; }
  input, button {
    padding:8px;
    margin:4px;
  }
  button {
    background:#2e7d32;
    color:#fff;
    border:none;
    cursor:pointer;
  }
  pre {
    background:#eee;
    padding:10px;
    max-height:200px;
    overflow:auto;
  }
</style>
</head>

<body>

<!-- ðŸ”’ LOGIN GUARD -->
<script>
(function () {
  const email = localStorage.getItem("email");
  const role  = localStorage.getItem("role");

  if (!email || role !== "admin") {
    alert("Unauthorized access. Please login.");
    window.location.href = "index.html";
  }
})();
</script>

<h2>ðŸŒ± GO GREEN â€“ Admin Dashboard</h2>

<button onclick="logout()">Logout</button>

<section>
  <button onclick="markMyAttendance()" class="btn">
  Mark My Attendance
</button>
  <button onclick="viewAttendance()">View My Attendance</button>
  <!-- Camera Section (HIDDEN INITIALLY) -->
<div id="cameraSection" style="display:none; margin-top:20px;">
  <video id="video" width="260" autoplay></video><br><br>
  <button onclick="captureAndMark()" class="btn">
    Capture Attendance
  </button>
</div>

<canvas id="canvas" width="260" height="200" style="display:none;"></canvas>

  <pre id="attendance"></pre>
</section>

<section>
  <h3>Add Location</h3>
  <input id="room" placeholder="Room No">
  <input id="lat" placeholder="Latitude">
  <input id="lng" placeholder="Longitude">
  <input id="rad" placeholder="Radius">
  <button onclick="addLocation()">Add</button>
</section>

<section>
  <h3>Add Subject</h3>
  <input id="sid" placeholder="Subject ID">
  <input id="sname" placeholder="Subject Name">
  <input id="dept" placeholder="Department">
  <input id="sem" placeholder="Semester">
  <button onclick="addSubject()">Add</button>
</section>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbwV_SjR5wASHwKWjWd-fLlVFFWbc-pGAUUVXcYlEOUbH1JeUnwILr-nMhPvHWLoUW19BQ/exec";
const email = localStorage.getItem("email");

/* ---- LOGOUT ---- */
function logout() {
  localStorage.clear();
  window.location.href = "index.html";
}

/* ---- POST HELPER ---- */
function post(data, cb) {
  fetch(API_URL, {
    method: "POST",
    body: JSON.stringify(data)
  })
  .then(r => r.json())
  .then(cb);
}

/* ---- ATTENDANCE ---- */
let stream = null;

function markMyAttendance() {
  document.getElementById("cameraSection").style.display = "block";

  navigator.mediaDevices.getUserMedia({ video: true })
    .then(s => {
      stream = s;
      document.getElementById("video").srcObject = s;
    })
    .catch(() => alert("Camera permission denied"));
}

function captureAndMark() {
  const canvas = document.getElementById("canvas");
  const video = document.getElementById("video");
  const ctx = canvas.getContext("2d");

  ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

  navigator.geolocation.getCurrentPosition(pos => {
    fetch(API_URL, {
      method: "POST",
      body: JSON.stringify({
        action: "markStaffAttendance",
        email: localStorage.getItem("email"),
        role: "ADMIN",
        latitude: pos.coords.latitude,
        longitude: pos.coords.longitude
      })
    })
    .then(r => r.json())
    .then(res => {
      alert("âœ… Attendance marked successfully");
      stopCamera();
    })
    .catch(() => alert("Network error"));
  });
}

function stopCamera() {
  if (stream) {
    stream.getTracks().forEach(t => t.stop());
    stream = null;
  }
  document.getElementById("cameraSection").style.display = "none";
}

function viewAttendance() {
  post({
    action: "getMyAttendance",
    email: email
  }, res => {
    document.getElementById("attendance").innerText =
      JSON.stringify(res.data, null, 2);
  });
}

/* ---- LOCATION ---- */
function addLocation() {
  post({
    action: "addLocation",
    room: room.value,
    lat: lat.value,
    lng: lng.value,
    radius: rad.value
  }, () => alert("Location added"));
}

/* ---- SUBJECT ---- */
function addSubject() {
  post({
    action: "addSubject",
    subjectId: sid.value,
    subjectName: sname.value,
    department: dept.value,
    semester: sem.value
  }, () => alert("Subject added"));
}
</script>

</body>
</html>
