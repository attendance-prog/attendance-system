<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>GO GREEN â€“ Coordinator Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://www.gstatic.com/charts/loader.js"></script>

<link rel="stylesheet"
 href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<style>
body{font-family:Arial;padding:20px;background:linear-gradient(135deg,#e8f5e9,#c8e6c9);}
h2{color:#2e7d32}
button{background:#2e7d32;color:#fff;border:none;padding:8px;margin:4px}
table{border-collapse:collapse;width:100%}
th,td{border:1px solid #ccc;padding:6px}
#welcomeBar{background:#1b5e20;color:white;padding:12px;border-radius:8px;margin-bottom:15px;}
#toast{position:fixed;bottom:20px;right:20px;background:#1b5e20;color:white;padding:10px 16px;border-radius:6px;display:none;}
</style>
</head>

<body>

<script>
if(localStorage.getItem("role")!=="coordinator"){
 alert("Unauthorized"); location.href="index.html";
}
</script>

<div id="welcomeBar"></div>
<h2>ğŸŒ± GO GREEN â€“ Coordinator Dashboard</h2>
<button onclick="logout()">Logout</button>

<hr>

<h3>My Attendance</h3>
<button onclick="startCamera()">Mark My Attendance</button>
<button onclick="viewMyAttendance()">View My Attendance</button>

<div id="cam" style="display:none">
<video id="video" autoplay width="260"></video><br>
<button onclick="capture()">Capture</button>
</div>

<table id="attTable" style="display:none">
<thead><tr><th>Date</th><th>Status</th><th>Time</th></tr></thead>
<tbody id="attBody"></tbody>
</table>

<hr>

<h3>ğŸ“Š My Attendance Analytics</h3>
Attendance %: <b id="myPct">--</b>
<div id="myChart" style="height:300px"></div>

<hr>

<h3>Faculty Timetable</h3>
<button onclick="loadTimetable()">Refresh</button>
<table><tbody id="ttBody"></tbody></table>

<hr>

<h3>ğŸ‘¨â€ğŸ« Faculty Attendance</h3>
<button onclick="loadFacultyAttendance()">Load</button>
<table id="facTable" style="display:none">
<tbody id="facBody"></tbody>
</table>

<hr>

<h3>ğŸ“ Faculty Leave Approval</h3>
<button onclick="loadLeaves()">Load Pending Leaves</button>
<table id="leaveTable">
<thead>
<tr><th>ID</th><th>Email</th><th>From</th><th>To</th><th>Reason</th><th>Action</th></tr>
</thead>
<tbody id="leaveBody"></tbody>
</table>

<hr>

<h3>ğŸ¤– Substitute Suggestions</h3>
<button onclick="suggestSub()">Suggest Substitute</button>
<div id="subBox"></div>

<hr>

<h3>ğŸ—º Attendance Map</h3>
<div id="map" style="height:300px"></div>

<div id="toast"></div>

<script>
const API="https://script.google.com/macros/s/AKfycbwV_SjR5wASHwKWjWd-fLlVFFWbc-pGAUUVXcYlEOUbH1JeUnwILr-nMhPvHWLoUW19BQ/exec";
const email=localStorage.getItem("email");
const toastBox=document.getElementById("toast");

/* ===== utils ===== */
function post(d){
 return fetch(API,{method:"POST",headers:{"Content-Type":"text/plain"},body:JSON.stringify(d)}).then(r=>r.json());
}
function toast(m){toastBox.innerText=m;toastBox.style.display="block";setTimeout(()=>toastBox.style.display="none",2500);}
function logout(){localStorage.clear();location.href="index.html"}

/* ===== greeting ===== */
welcomeBar.innerHTML="Coordinator Panel";

/* ===== leaves ===== */
function loadLeaves(){
 post({action:"getPendingLeaves"}).then(r=>{
  leaveBody.innerHTML="";
  r.data.forEach(l=>{
   leaveBody.innerHTML+=`
   <tr>
   <td>${l[0]}</td>
   <td>${l[1]}</td>
   <td>${l[2]}</td>
   <td>${l[3]}</td>
   <td>${l[4]}</td>
   <td>
   <button onclick="approve('${l[0]}')">Approve</button>
   </td>
   </tr>`;
  });
 });
}

function approve(id){
 post({
  action:"approveLeave",
  leaveId:id,
  approver:email
 }).then(()=>toast("Approved"));
}

/* ===== substitute ===== */
function suggestSub(){
 post({action:"suggestSubstitute"}).then(r=>{
  subBox.innerHTML="Suggested: "+(r.suggested||[]).join(", ");
 });
}

/* ===== map ===== */
const map=L.map("map").setView([28.47,77.48],16);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);

post({action:"getGpsPoints"}).then(r=>{
 r.data.forEach(p=>{
  if(p.lat) L.marker([p.lat,p.lng]).addTo(map);
 });
});
</script>
</body>
</html>
