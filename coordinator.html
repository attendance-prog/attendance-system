<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>GO GREEN â€“ Coordinator Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
body{font-family:Arial;background:#f4fff4;padding:20px}
h2{color:#2e7d32}
button{background:#2e7d32;color:#fff;border:none;padding:8px;margin:4px;cursor:pointer}
input,select{padding:6px;margin:4px}
table{border-collapse:collapse;width:100%}
th,td{border:1px solid #ccc;padding:6px}
</style>
</head>

<body>

<script>
(() => {
  if(localStorage.getItem("role")!=="coordinator"){
    alert("Unauthorized");
    location.href="index.html";
  }
})();
</script>

<h2>ðŸŒ± GO GREEN â€“ Coordinator Dashboard</h2>
<button onclick="logout()">Logout</button>

<hr>

<h3>My Attendance</h3>
<button onclick="startCamera()">Mark My Attendance</button>
<button onclick="viewMyAttendance()">View My Attendance</button>

<div id="cam" style="display:none">
  <video id="video" autoplay width="260"></video><br>
  <button onclick="capture()">Capture</button>
</div>
<canvas id="canvas" width="260" height="200" style="display:none"></canvas>

<table id="attTable" style="display:none">
<thead><tr><th>Date</th><th>Status</th><th>Time</th></tr></thead>
<tbody id="attBody"></tbody>
</table>

<hr>

<h3>Faculty Timetable (View Only)</h3>
<table>
<thead>
<tr>
  <th>Day</th>
  <th>Subject ID</th>
  <th>Faculty Email</th>
  <th>Room</th>
  <th>Action</th>
</tr>
</thead>
<tbody id="ttBody"></tbody>
</table>

<script>
const API="https://script.google.com/macros/s/AKfycbwV_SjR5wASHwKWjWd-fLlVFFWbc-pGAUUVXcYlEOUbH1JeUnwILr-nMhPvHWLoUW19BQ/exec";
const email=localStorage.getItem("email");
let stream=null;

function logout(){localStorage.clear();location.href="index.html"}
function post(d){return fetch(API,{method:"POST",body:JSON.stringify(d)}).then(r=>r.json())}

/* OWN ATTENDANCE */
function startCamera(){
  cam.style.display="block";
  navigator.mediaDevices.getUserMedia({video:true}).then(s=>{
    stream=s;video.srcObject=s;
  });
}

function capture(){
  canvas.getContext("2d").drawImage(video,0,0,260,200);
  navigator.geolocation.getCurrentPosition(pos=>{
    post({
      action:"markCoordinatorAttendance",
      email,
      latitude:pos.coords.latitude,
      longitude:pos.coords.longitude
    }).then(r=>{
      alert(r.message);
      stream.getTracks().forEach(t=>t.stop());
      cam.style.display="none";
    });
  });
}

function viewMyAttendance(){
  post({action:"getMyAttendance",email}).then(r=>{
    attBody.innerHTML="";
    r.data.forEach(x=>{
      attBody.innerHTML+=`
      <tr>
        <td>${new Date(x[0]).toLocaleDateString()}</td>
        <td>${x[6]}</td>
        <td>${new Date(x[8]).toLocaleTimeString()}</td>
      </tr>`;
    });
    attTable.style.display="table";
  });
}

/* FACULTY TIMETABLE */
function loadTimetable(){
  post({action:"getFacultyTimetable"}).then(r=>{
    ttBody.innerHTML="";
    r.data.forEach(x=>{
      ttBody.innerHTML+=`
      <tr>
        <td>${x[0]}</td>
        <td>${x[1]}</td>
        <td>${x[2]}</td>
        <td>${x[4]}</td>
        <td>
          <button onclick="assist('${x[1]}','${x[2]}')">
            Take Lecture
          </button>
        </td>
      </tr>`;
    });
  });
}

function assist(subject,faculty){
  if(!confirm("Faculty absent? Take lecture as coordinator?"))return;

  navigator.geolocation.getCurrentPosition(pos=>{
    post({
      action:"coordinatorTakeLecture",
      coordinator:email,
      faculty,
      subject,
      latitude:pos.coords.latitude,
      longitude:pos.coords.longitude
    }).then(r=>alert(r.message));
  });
}

loadTimetable();
  function stopCamera(){
  if (stream) {
    stream.getTracks().forEach(t => t.stop());
    stream = null;
  }
  cam.style.display = "none";
}

</script>

</body>
</html>
