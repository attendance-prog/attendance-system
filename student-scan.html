<!DOCTYPE html>
<html>
<head>
  <title>Scan QR</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="https://unpkg.com/html5-qrcode"></script>

  <style>
    body { font-family: Arial; background:#f4f6f8; padding:20px; text-align:center }
    #reader { width:300px; margin:auto }
    input,button { width:100%; padding:12px; margin-top:10px }
    button { background:#0a5fb4; color:#fff; border:none }
  </style>
</head>

<body>

<h3>ðŸ“· Scan QR & Mark Attendance</h3>

<div id="reader"></div>

<input id="sessionId" placeholder="Session ID" readonly>
<input id="roll" placeholder="Roll Number">
<input id="name" placeholder="Name">

<button onclick="verifyFace()">ðŸ“¸ Verify Face</button>
<button onclick="markAttendance()">âœ… Mark Attendance</button>
<button onclick="goBack()" style="background:#c0392b">â¬… Back</button>

<script>
let scanned = false, faceOk = false;
const API = google.script.host.origin + "/exec";

new Html5Qrcode("reader").start(
  { facingMode:"environment" },
  { fps:10, qrbox:250 },
  txt => {
    document.getElementById("sessionId").value = txt;
    scanned = true;
    alert("QR Scanned");
  }
);

async function verifyFace(){
  try{
    const s = await navigator.mediaDevices.getUserMedia({video:true});
    setTimeout(()=>{ s.getTracks().forEach(t=>t.stop()); faceOk=true; alert("Face Verified"); },2000);
  }catch{ alert("Camera blocked"); }
}

function markAttendance(){
  if(!scanned || !faceOk) return alert("Scan QR & verify face");

  navigator.geolocation.getCurrentPosition(pos=>{
    fetch(`${API}?action=markStudentAttendance&sessionId=${sessionId.value}&roll=${roll.value}&name=${name.value}&lat=${pos.coords.latitude}&lng=${pos.coords.longitude}`)
      .then(r=>r.text()).then(alert);
  });
}

function goBack(){
  window.location.href = "?page=student";
}
</script>

</body>
</html>
